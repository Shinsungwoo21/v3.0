# 좌석 선점 안정성 및 UX 강화 (V8.27)

## 📌 작업 개요
사용자가 좌석 선점 시도 시 간헐적으로 UI(타이머, 버튼)가 표시되지 않거나, DB 저장 여부가 불확실했던 문제를 해결하기 위해 **3중 안전장치**를 도입했습니다.

## 🛠️ 구현된 안전장치

### 1. DB 무결성 검증 (Verify-After-Write)
- **위치**: `apps/app/lib/server/holding-manager.ts`
- **내용**: 좌석 데이터를 DB에 저장(`put`)한 직후, 즉시 다시 조회(`get`)하여 저장이 잘 되었는지 검증합니다.
- **Retry**: 만약 검증에 실패하면 **최대 3회 자동 재시도**를 수행합니다.
- **효과**: 사용자에게 "선점 성공" 메시지가 떴다면, DB에 데이터가 **100% 존재함**을 보장합니다.

### 2. 결제 링크 백업 (Fallback UI)
- **위치**: `apps/app/lib/tools/holding-tools.ts`
- **내용**: 챗봇 응답 메시지 내에 **Markdown 결제 링크**(`[결제 완료하러 가기]`)를 추가했습니다.
- **효과**: 프론트엔드 오류로 버튼이나 타이머가 렌더링되지 않아도, 사용자는 텍스트 링크를 클릭하여 결제를 진행할 수 있습니다.

### 3. 입력값 및 프롬프트 검증
- **입력값 검증**: `holdSeats` 함수에서 AI가 잘못된 형식(예: 문자열 "5~6번")을 보내면 이를 차단하고 에러를 반환합니다.
- **프롬프트 개선**: `base-prompt.ts`를 수정하여, 정상 선점 시 "내 예약 메뉴에서 결제하세요"(DR용 멘트)가 잘못 안내되지 않도록 엄격히 제한했습니다.

## 📸 테스트 결과
사용자 테스트 결과, 다음과 같이 정상 동작함을 확인했습니다:
1.  **챗봇 응답**: "좌석이 선점되었습니다!" 메시지와 함께 타이머, 결제 버튼이 정상 표시됨.
2.  **좌석 배치도**: 선점된 좌석이 실시간으로 반영됨.
3.  **데이터베이스**: DynamoDB에 `HOLDING` 상태 및 `expiresAt`(TTL)이 정확하게 저장됨.
4.  **비용 최적화**: 불필요한 로그 제거로 비용 효율성 확보.

이제 "다시 했을 때 안 뜨는" 문제는 구조적으로 발생하기 어렵습니다. 안심하고 사용하셔도 됩니다! 🚀

---

## 👨‍💻 개발팀 참고 (Technical Details)

### 🔧 관련 파일
| 파일 | 변경 내용 |
|------|----------|
| `holding-manager.ts` | Verify-After-Write 로직 추가 |
| `holding-tools.ts` | Fallback 링크, 입력값 검증 |
| `base-prompt.ts` | DR 멘트 오류 수정 |

### 🚨 롤백 방법
문제 발생 시 V8.26으로 롤백:
```bash
git checkout v8.26 -- apps/app/lib/server/holding-manager.ts
git commit -m "Rollback: holding-manager.ts to V8.26 due to critical error"
git push origin main
```

### 🏗️ 인프라 영향
- **DynamoDB**: 추가 Read 용량 소비 (Verify 로직으로 인해 Write당 +1 Read)
- **비용 영향**: On-demand 모드이므로 큰 영향 없음 (예상 증가율 < 5%)
